#!/usr/bin/env ruby
require "optparse"

# remove tags previously prepended by prepend-video-tags.
# arguments: [options] path ...
# options
#   --dry-run

dry_run = false
OptionParser.new { |o| o.on("--dry-run") { dry_run = true } }.parse!

RX = /\A(?:[dpqf][0-9]{1,5})+\z/.freeze
OLD_RX = /\A(?:d[0-9]-)?(?:[0-9]q)?[0-9]{1,4}(?:p|r|hs|q|l|ks)[0-9]*-?[0-9]*\z/.freeze

def remove_tags(name)
  name.split(".").reject { |s| s.match?(RX) || s.match?(OLD_RX) }.join(".")
end

def q(s) s.inspect end

ARGV.each do |path|
  old = File.expand_path(path)
  dir = File.dirname(old)
  base = File.basename(old)
  new_base = remove_tags(base)
  next if new_base == base || new_base.empty?
  new_path = File.join(dir, new_base)
  if dry_run
    puts "#{q(old)} -> #{q(new_path)}"
  else
    File.rename(old, new_path)
  end
end
